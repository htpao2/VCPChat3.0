<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Live2D 模型管理器</title>
    <style>
        html, body {
            height: 100%; margin: 0; padding: 0; background: #eee; color: #222;
            font-family: 'Segoe UI', Arial, sans-serif; overflow: hidden;
        }
        #live2d-container {
            position: fixed; right: 0px; bottom: 0px; width: 100%; height: 100%;
            z-index: 10; pointer-events: auto;
        }
        #live2d-canvas {
            display: block; width: 100%; height: 100%; background: transparent;
            cursor: grab; pointer-events: auto;
        }
        #live2d-canvas:active { cursor: grabbing; }

        #sidebar {
            position: fixed;
            left: 20px;
            top: 20px;
            display: flex;
            flex-direction: column;
            gap: 15px;
            z-index: 20;
            min-width: 280px;
            padding: 20px;
            background: rgba(255, 255, 255, 0.85);
            border-radius: 12px;
            box-shadow: 0 4px 12px rgba(0,0,0,0.1);
            backdrop-filter: blur(10px);
        }
        .control-group {
            display: flex;
            flex-direction: column;
            gap: 8px;
        }
        .control-label {
            font-weight: 600;
            color: #333;
            font-size: 14px;
        }
        .control-select, .btn {
            padding: 10px 15px;
            border-radius: 8px;
            border: 1px solid #ccc;
            font-size: 14px;
            cursor: pointer;
            background: #fff;
        }
        .btn {
            color: white;
            border: none;
            transition: background 0.2s, transform 0.2s, box-shadow 0.2s;
            text-align: center;
        }
        .btn:hover:not(:disabled) {
            transform: translateY(-1px);
            box-shadow: 0 2px 6px rgba(0,0,0,0.1);
        }
        .btn:disabled {
            background: #e0e0e0;
            cursor: not-allowed;
            opacity: 0.7;
        }
        .btn-primary { background: #667eea; }
        .btn-primary:hover:not(:disabled) { background: #5a6fd8; }
        
        .btn-secondary { background: #6c757d; }
        .btn-secondary:hover:not(:disabled) { background: #5a6268; }

        .btn-success { background: #28a745; }
        .btn-success:hover:not(:disabled) { background: #218838; }

        .action-group {
            display: flex;
            gap: 10px;
        }
        .action-group .control-select {
            flex-grow: 1;
        }
        #status {
            margin-top: 10px;
            color: #4f8cff;
            font-size: 14px;
            font-weight: 500;
            max-width: 280px;
            word-break: break-all;
        }
        #chat-container-placeholder { 
            pointer-events: auto; 
            position: fixed; 
            left: 20px; 
            bottom: 20px; 
            width: 340px;
            height: 300px; 
            background: rgba(247, 248, 250, 0.7);
            border-radius: 12px; 
            padding: 16px;
            box-sizing: border-box; 
            z-index: 20; 
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.08);
            display: flex; 
            flex-direction: column; 
            backdrop-filter: blur(10px);
        }
        #chat-content-wrapper { 
            flex-grow: 1; 
            padding-left: 8px; 
            overflow-y: auto; 
            opacity: 0.7; 
        }
    </style>
</head>
<body>

<div id="sidebar">
    <div class="control-group">
        <button id="fullscreenBtn" class="btn btn-secondary">🖥️ 全屏</button>
        <button id="exitFullscreenBtn" class="btn btn-secondary" style="display:none;">❌ 退出全屏</button>
    </div>
    <div class="control-group">
        <label for="model-select" class="control-label">选择模型:</label>
        <select id="model-select" class="control-select">
            <option>加载中...</option>
        </select>
    </div>

    <div class="control-group">
        <label class="control-label">动作预览:</label>
        <div class="action-group">
            <select id="motion-select" class="control-select" disabled>
                <option>请先加载模型</option>
            </select>
            <button id="play-motion-btn" class="btn btn-primary" disabled>播放</button>
        </div>
    </div>
    
    <div class="control-group">
        <label class="control-label">表情预览:</label>
        <div class="action-group">
            <select id="expression-select" class="control-select" disabled>
                <option>请先加载模型</option>
            </select>
            <button id="play-expression-btn" class="btn btn-primary" disabled>播放</button>
        </div>
    </div>

    <div class="control-group">
        <div style="display:flex; gap: 10px;">
            <button id="emotion-manager-btn" class="btn btn-secondary" disabled style="flex:1;">⚙️ 情感配置</button>
            <button id="save-position-btn" class="btn btn-success" disabled style="flex:1;">💾 保存设置</button>
        </div>
    </div>

    <div class="control-group" id="persistent-box" style="display:none;">
        <label class="control-label">常驻表情（仅expression）:</label>
        <div class="action-group">
            <select id="persistent-expression-select" class="control-select" disabled>
                <option>请先加载模型</option>
            </select>
            <button id="add-persistent-btn" class="btn btn-primary" disabled>添加</button>
        </div>
        <div id="persistent-list" style="margin-top:6px; max-height:120px; overflow:auto; border:1px solid #ddd; border-radius:8px; padding:6px; background:#fff;"></div>
        <button id="save-persistent-btn" class="btn btn-success" disabled style="margin-top:6px;">保存常驻表情</button>
        <div style="font-size:12px; color:#666;">常驻表情会一直生效，不会被清除或覆盖；此处仅能选择 .exp3.json。</div>
    </div>
    
    <div id="status">正在初始化...</div>
</div>

<div id="chat-container-placeholder">
    <div id="chat-content-wrapper"><p style="color: #888">对话历史界面<br><br>...现在是一片空白...</p></div>
</div>

<div id="live2d-container"><canvas id="live2d-canvas"></canvas></div>

<script src="/static/libs/live2dcubismcore.min.js"></script>
<script src="/static/libs/live2d.min.js"></script>
<script src="/static/libs/pixi.min.js"></script>
<script src="/static/libs/index.min.js"></script>
<script src="/static/live2d.js"></script>

<script>
    document.addEventListener('DOMContentLoaded', async () => {
        const statusDiv = document.getElementById('status');
        const modelSelect = document.getElementById('model-select');
        const motionSelect = document.getElementById('motion-select');
        const expressionSelect = document.getElementById('expression-select');
        const playMotionBtn = document.getElementById('play-motion-btn');
        const playExpressionBtn = document.getElementById('play-expression-btn');
        const emotionManagerBtn = document.getElementById('emotion-manager-btn');
        const savePositionBtn = document.getElementById('save-position-btn');
        const persistentBox = document.getElementById('persistent-box');
        const persistentSelect = document.getElementById('persistent-expression-select');
        const addPersistentBtn = document.getElementById('add-persistent-btn');
        const persistentList = document.getElementById('persistent-list');
        const savePersistentBtn = document.getElementById('save-persistent-btn');
        const fullscreenBtn = document.getElementById('fullscreenBtn');
        const exitFullscreenBtn = document.getElementById('exitFullscreenBtn');

        let currentModelInfo = null;
        let availableModels = [];
        let currentModelFiles = { motion_files: [], expression_files: [] };
        let live2dModel = null;
        let currentEmotionMapping = null; // { motions: {...}, expressions: {...} }
        let currentPersistent = []; // expressions.常驻

        const showStatus = (msg, duration = 0) => {
            statusDiv.textContent = msg;
            if (duration > 0) {
                setTimeout(() => {
                    if (currentModelInfo) {
                        showStatus(`当前模型: ${currentModelInfo.name}`);
                    }
                }, duration);
            }
        };

        await window.live2dManager.initPIXI('live2d-canvas', 'live2d-container');
        showStatus('PIXI 初始化完成');

        // 加载当前角色的模型
        await loadCurrentCharacterModel();

        try {
            const response = await fetch('/api/live2d/models');
            availableModels = await response.json();
            if (availableModels.length > 0) {
                modelSelect.innerHTML = '<option value="">请选择一个模型</option>';
                availableModels.forEach(model => {
                    const option = document.createElement('option');
                    option.value = model.name;
                    option.textContent = model.name;
                    modelSelect.appendChild(option);
                });
                showStatus('模型列表加载成功');
            } else {
                showStatus('未找到可用模型');
            }
        } catch (e) {
            showStatus('加载模型列表失败');
        }

        // 保存模型设置到角色的函数
        async function saveModelToCharacter(modelName) {
            try {
                // 从URL参数中获取角色名称
                const urlParams = new URLSearchParams(window.location.search);
                const lanlanName = urlParams.get('lanlan_name') || '';
                
                if (!lanlanName) {
                    showStatus('无法保存：未指定角色名称');
                    return false;
                }
                
                const response = await fetch(`/api/characters/catgirl/l2d/${encodeURIComponent(lanlanName)}`, {
                    method: 'PUT',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({ live2d: modelName })
                });
                
                const result = await response.json();
                
                if (result.success) {
                    showStatus(`已保存模型设置: ${lanlanName} -> ${modelName}`, 2000);
                    return true;
                } else {
                    showStatus(`保存失败: ${result.error}`, 3000);
                    return false;
                }
            } catch (error) {
                console.error('保存模型设置失败:', error);
                showStatus('保存模型设置失败', 3000);
                return false;
            }
        }

        // 修改模型选择事件，自动保存模型设置
        modelSelect.addEventListener('change', async (e) => {
            const modelName = e.target.value;
            if (!modelName) return;

            currentModelInfo = availableModels.find(m => m.name === modelName);
            if (!currentModelInfo) return;

            await loadModel(modelName, currentModelInfo);
            
            // 自动保存模型设置到角色
            await saveModelToCharacter(modelName);
        });

        // 加载模型的函数
        async function loadModel(modelName, modelInfo) {
            if (!modelName || !modelInfo) return;
            
            showStatus(`正在加载模型: ${modelName}...`);
            setControlsDisabled(true);

            try {
                // 1. Fetch files list
                const filesRes = await fetch(`/api/live2d/model_files/${modelName}`);
                const filesData = await filesRes.json();
                if (!filesData.success) throw new Error('无法获取模型文件列表');
                currentModelFiles = filesData;

                // 2. Fetch model config
                const modelJsonUrl = modelInfo.path;
                const modelConfigRes = await fetch(modelJsonUrl);
                if (!modelConfigRes.ok) throw new Error(`无法获取模型配置: ${modelConfigRes.statusText}`);
                const modelConfig = await modelConfigRes.json();
                
                // 3. Add URL context for the loader
                modelConfig.url = modelJsonUrl;

                // 4. Inject PreviewAll motion group AND ensure all expressions are referenced
                if (!modelConfig.FileReferences) modelConfig.FileReferences = {};

                // Motions
                if (!modelConfig.FileReferences.Motions) modelConfig.FileReferences.Motions = {};
                // 只有当模型有动作文件时才添加PreviewAll组
                if (currentModelFiles.motion_files.length > 0) {
                    modelConfig.FileReferences.Motions.PreviewAll = currentModelFiles.motion_files.map(file => ({
                        File: file  // 直接使用API返回的完整路径
                    }));
                }

                // Expressions: Overwrite with all available expression files for preview purposes.
                modelConfig.FileReferences.Expressions = currentModelFiles.expression_files.map(file => ({
                    Name: file.split('/').pop().replace('.exp3.json', ''),  // 从路径中提取文件名作为名称
                    File: file  // 直接使用API返回的完整路径
                }));
                
                // 5. Load preferences
                const preferences = await window.live2dManager.loadUserPreferences();
                console.log('加载的偏好设置:', preferences);
                console.log('当前模型路径:', modelInfo.path);
                const modelPreferences = preferences.find(p => p && p.model_path === modelInfo.path) || null;
                console.log('匹配的模型偏好:', modelPreferences);

                // 6. Load model FROM THE MODIFIED OBJECT
                await window.live2dManager.loadModel(modelConfig, {
                    loadEmotionMapping: true,
                    dragEnabled: true,
                    wheelEnabled: true,
                    preferences: modelPreferences
                });
                live2dModel = window.live2dManager.getCurrentModel();

                updateSelectWithOptions(motionSelect, currentModelFiles.motion_files, '选择动作');
                updateSelectWithOptions(expressionSelect, currentModelFiles.expression_files, '选择表情');

                // 7. Load current emotion mapping for this model
                await loadEmotionMappingForModel(modelName);
                renderPersistentUI();
                
                // 如果没有动作文件，禁用动作相关控件
                if (currentModelFiles.motion_files.length === 0) {
                    motionSelect.disabled = true;
                    playMotionBtn.disabled = true;
                    motionSelect.innerHTML = '<option value="">该模型没有动作文件</option>';
                }
                setControlsDisabled(false);
                showStatus(`模型 ${modelName} 加载成功`);

            } catch (error) {
                showStatus(`加载模型 ${modelName} 失败`);
                console.error(error);
                setControlsDisabled(false);
            }
        }

        playMotionBtn.addEventListener('click', () => {
            if (!live2dModel || !motionSelect.value) return;
            
            // 检查是否有动作文件
            if (currentModelFiles.motion_files.length === 0) {
                showStatus('该模型没有动作文件', 2000);
                return;
            }
            
            const motionIndex = currentModelFiles.motion_files.indexOf(motionSelect.value);
            if (motionIndex > -1) {
                try {
                    live2dModel.motion('PreviewAll', motionIndex, 3);
                    showStatus(`播放动作: ${motionSelect.value}`, 1000);
                } catch (error) {
                    console.error('播放动作失败:', error);
                    showStatus(`播放动作失败: ${motionSelect.value}`, 2000);
                }
            } else {
                showStatus('动作文件不存在', 2000);
            }
        });

        playExpressionBtn.addEventListener('click', () => {
            if (!live2dModel || !expressionSelect.value) return;
            // 从完整路径中提取表情名称（去掉路径和扩展名）
            const expressionName = expressionSelect.value.split('/').pop().replace('.exp3.json', '');
            console.log('播放表情:', expressionName); // 添加调试信息
            try {
                live2dModel.expression(expressionName);
                showStatus(`播放表情: ${expressionName}`, 1000);
            } catch (error) {
                console.error('播放表情失败:', error);
                showStatus(`播放表情失败: ${expressionName}`, 2000);
            }
        });

        emotionManagerBtn.addEventListener('click', () => {
            if (!currentModelInfo) return;
            openModal('/live2d_emotion_manager');
        });

        savePositionBtn.addEventListener('click', async () => {
            if (!currentModelInfo || !live2dModel) return;
            showStatus('正在保存设置...');
            
            // 添加调试信息
            console.log('保存设置 - 模型路径:', currentModelInfo.path);
            console.log('保存设置 - 当前位置:', { x: live2dModel.x, y: live2dModel.y });
            console.log('保存设置 - 当前缩放:', { x: live2dModel.scale.x, y: live2dModel.scale.y });
            
            // 保存位置和缩放
            const positionSuccess = await window.live2dManager.saveUserPreferences(
                currentModelInfo.path,
                { x: live2dModel.x, y: live2dModel.y },
                { x: live2dModel.scale.x, y: live2dModel.scale.y }
            );
            
            // 保存模型设置到角色
            const modelSuccess = await saveModelToCharacter(currentModelInfo.name);
            
            if (positionSuccess && modelSuccess) {
                showStatus('位置和模型设置保存成功!', 2000);
            } else if (positionSuccess) {
                showStatus('位置保存成功，模型设置保存失败!', 2000);
            } else if (modelSuccess) {
                showStatus('模型设置保存成功，位置保存失败!', 2000);
            } else {
                showStatus('保存失败!', 2000);
            }
        });
        
        // Fullscreen logic
        fullscreenBtn.onclick = () => document.documentElement.requestFullscreen?.();
        exitFullscreenBtn.onclick = () => document.exitFullscreen?.();
        const updateFullscreenButtons = () => {
            const isFullscreen = !!document.fullscreenElement;
            fullscreenBtn.style.display = isFullscreen ? 'none' : '';
            exitFullscreenBtn.style.display = isFullscreen ? '' : 'none';
        };
        document.addEventListener('fullscreenchange', updateFullscreenButtons);
        updateFullscreenButtons();

        // Helper functions
        function setControlsDisabled(disabled) {
            motionSelect.disabled = disabled;
            expressionSelect.disabled = disabled;
            playMotionBtn.disabled = disabled;
            playExpressionBtn.disabled = disabled;
            emotionManagerBtn.disabled = disabled;
            savePositionBtn.disabled = disabled;
            persistentSelect.disabled = disabled;
            addPersistentBtn.disabled = disabled;
            savePersistentBtn.disabled = disabled;
        }

        function updateSelectWithOptions(select, options, defaultText) {
            select.innerHTML = `<option value="">${defaultText}</option>`;
            options.forEach(opt => {
                const option = document.createElement('option');
                option.value = opt;
                // 为表情文件提供更友好的显示名称
                if (defaultText.includes('表情')) {
                    const displayName = opt.split('/').pop().replace('.exp3.json', '');
                    option.textContent = displayName;
                } else if (defaultText.includes('动作')) {
                    // 为动作文件提供更友好的显示名称（去掉路径和扩展名）
                    const displayName = opt.split('/').pop().replace('.motion3.json', '');
                    option.textContent = displayName;
                } else {
                    option.textContent = opt;
                }
                select.appendChild(option);
            });
        }

        function openModal(url) {
            const modal = document.createElement('div');
            modal.style.cssText = `position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.7); z-index: 10000; display: flex; justify-content: center; align-items: center;`;
            
            const iframeContainer = document.createElement('div');
            iframeContainer.style.cssText = `background: white; border-radius: 15px; width: 95%; height: 95%; max-width: 1500px; box-shadow: 0 10px 30px rgba(0,0,0,0.2); display: flex; flex-direction: column; overflow: hidden;`;

            const header = document.createElement('div');
            header.style.cssText = `padding: 12px 20px; background: #f1f3f5; border-bottom: 1px solid #dee2e6; display: flex; justify-content: space-between; align-items: center;`;
            
            const title = document.createElement('h3');
            title.textContent = '情感配置管理器';
            title.style.cssText = 'margin: 0;';

            const closeButton = document.createElement('button');
            closeButton.textContent = '×';
            closeButton.style.cssText = `background: none; border: none; font-size: 24px; cursor: pointer;`;

            const iframe = document.createElement('iframe');
            iframe.src = url;
            iframe.style.cssText = 'width: 100%; height: 100%; border: none;';

            const closeModal = () => {
                modal.remove();
                if (currentModelInfo) {
                    modelSelect.value = currentModelInfo.name;
                    modelSelect.dispatchEvent(new Event('change'));
                }
            };
            
            closeButton.onclick = closeModal;
            header.appendChild(title);
            header.appendChild(closeButton);
            iframeContainer.appendChild(header);
            iframeContainer.appendChild(iframe);
            modal.appendChild(iframeContainer);
            document.body.appendChild(modal);
        }

        // ===== 常驻表情 管理 =====
        async function loadEmotionMappingForModel(modelName) {
            currentEmotionMapping = null;
            currentPersistent = [];
            try {
                const res = await fetch(`/api/live2d/emotion_mapping/${encodeURIComponent(modelName)}`);
                const data = await res.json();
                if (data && data.success && data.config) {
                    currentEmotionMapping = data.config;
                } else {
                    currentEmotionMapping = { motions: {}, expressions: {} };
                }
            } catch (e) {
                currentEmotionMapping = { motions: {}, expressions: {} };
            }
            const expr = (currentEmotionMapping.expressions || {});
            currentPersistent = Array.isArray(expr['常驻']) ? [...expr['常驻']] : [];
        }

        function renderPersistentUI() {
            persistentBox.style.display = '';
            // 可选：所有表达式 - 已选（常驻）
            const unused = (currentModelFiles.expression_files || []).filter(f => !currentPersistent.includes(f));
            updateSelectWithOptions(persistentSelect, unused, '选择常驻表情');

            // 列表
            if (!currentPersistent.length) {
                persistentList.innerHTML = '<div style="color:#999;">尚未添加常驻表情</div>';
            } else {
                persistentList.innerHTML = currentPersistent.map(f => {
                    const name = f.split('/').pop().replace('.exp3.json','');
                    return `<div style="display:flex; align-items:center; justify-content:space-between; padding:4px 6px; border-bottom:1px dashed #eee;">
                        <span>${name}</span>
                        <button data-file="${f}" class="btn btn-secondary" style="padding:4px 8px; font-size:12px;">移除</button>
                    </div>`;
                }).join('');
                // 绑定移除
                Array.from(persistentList.querySelectorAll('button[data-file]')).forEach(btn => {
                    btn.onclick = () => {
                        const file = btn.getAttribute('data-file');
                        const idx = currentPersistent.indexOf(file);
                        if (idx > -1) currentPersistent.splice(idx, 1);
                        renderPersistentUI();
                    };
                });
            }
            // 启用相关控件
            persistentSelect.disabled = false;
            addPersistentBtn.disabled = false;
            savePersistentBtn.disabled = false;
        }

        addPersistentBtn.addEventListener('click', () => {
            const file = persistentSelect.value;
            if (!file) return;
            if (!currentPersistent.includes(file)) currentPersistent.push(file);
            renderPersistentUI();
        });

        savePersistentBtn.addEventListener('click', async () => {
            if (!currentModelInfo) return;
            showStatus('正在保存常驻表情...');
            try {
                // 合并旧映射：保留 motions，保留 expressions 其他组，仅替换 常驻 组
                const motions = (currentEmotionMapping && currentEmotionMapping.motions) ? currentEmotionMapping.motions : {};
                const expressions = Object.assign({}, (currentEmotionMapping && currentEmotionMapping.expressions) ? currentEmotionMapping.expressions : {});
                expressions['常驻'] = [...currentPersistent];

                const body = { motions, expressions };
                const resp = await fetch(`/api/live2d/emotion_mapping/${encodeURIComponent(currentModelInfo.name)}`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(body)
                });
                const result = await resp.json();
                if (result && result.success) {
                    showStatus('常驻表情保存成功', 1500);
                    // 通知前端管理器重新应用常驻，无需重载模型
                    if (window.live2dManager && window.live2dManager.setupPersistentExpressions) {
                        await window.live2dManager.setupPersistentExpressions();
                    }
                } else {
                    showStatus('保存常驻表情失败', 2000);
                }
            } catch (e) {
                console.error(e);
                showStatus('保存常驻表情失败', 2000);
            }
        });

        // 加载当前角色模型的函数
        async function loadCurrentCharacterModel() {
            try {
                // 从URL参数中获取角色名称
                const urlParams = new URLSearchParams(window.location.search);
                const lanlanName = urlParams.get('lanlan_name') || '';
                
                let apiUrl = '/api/characters/current_live2d_model';
                if (lanlanName) {
                    apiUrl += `?catgirl_name=${encodeURIComponent(lanlanName)}`;
                }
                
                const currentModelResponse = await fetch(apiUrl);
                const currentModelData = await currentModelResponse.json();
                
                if (!currentModelData.success) {
                    console.log('无法获取当前角色模型信息:', currentModelData.error);
                    return;
                }
                
                const { catgirl_name, model_name, model_info } = currentModelData;
                
                if (model_name && model_info) {
                    // 如果角色有设置的模型，自动加载
                    console.log(`自动加载角色 ${catgirl_name} 的模型: ${model_name}`);
                    showStatus(`正在加载角色 ${catgirl_name} 的模型: ${model_name}...`);
                    
                    // 设置模型选择器
                    currentModelInfo = model_info;
                    modelSelect.value = model_name;
                    
                    // 加载模型
                    await loadModel(model_name, model_info);
                    
                    showStatus(`已加载角色 ${catgirl_name} 的模型: ${model_name}`);
                } else {
                    // 如果角色没有设置模型，显示提示信息
                    console.log(`角色 ${catgirl_name} 未设置Live2D模型`);
                    showStatus(`角色 ${catgirl_name} 未设置模型，请手动选择`);
                }
            } catch (error) {
                console.error('加载当前角色模型失败:', error);
                showStatus('加载当前角色模型失败');
            }
        }
    });
</script>

</body>
</html>
