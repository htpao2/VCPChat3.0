<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Live2D 情感映射管理器</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

                 body {
             font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
             background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
             background-attachment: fixed;
             min-height: 100vh;
             padding: 10px;
             margin: 0;
         }

                 .container {
             max-width: 1400px;
             margin: 0 auto;
             background: white;
             border-radius: 15px;
             box-shadow: 0 10px 30px rgba(0, 0, 0, 0.1);
             overflow: hidden;
             min-height: calc(100vh - 20px);
             display: flex;
             flex-direction: column;
         }

                 .header {
             background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
             color: white;
             padding: 15px;
             text-align: center;
             flex-shrink: 0;
             opacity: 0.9;
         }

                 .header h1 {
             font-size: 1.6em;
             margin-bottom: 5px;
             font-weight: 500;
         }

                 .header p {
             font-size: 0.9em;
             opacity: 0.8;
         }

                 .content {
             padding: 20px;
             flex: 1;
             overflow: hidden;
             display: flex;
             flex-direction: column;
             position: relative;
         }

        

        .btn {
            padding: 12px 24px;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            font-size: 14px;
            font-weight: 600;
            transition: all 0.3s ease;
            text-decoration: none;
            display: inline-block;
        }

        .btn-primary {
            background: #667eea;
            color: white;
        }

        .btn-primary:hover {
            background: #5a6fd8;
            transform: translateY(-2px);
        }

        .btn-success {
            background: #28a745;
            color: white;
        }

        .btn-success:hover {
            background: #218838;
            transform: translateY(-2px);
        }

        .btn-danger {
            background: #dc3545;
            color: white;
        }

        .btn-danger:hover {
            background: #c82333;
            transform: translateY(-2px);
        }

        .btn-secondary {
            background: #6c757d;
            color: white;
        }

        .btn-secondary:hover {
            background: #5a6268;
            transform: translateY(-2px);
        }

        .btn-info {
            background: #17a2b8;
            color: white;
        }

        .btn-info:hover {
            background: #138496;
            transform: translateY(-2px);
        }

                 .model-selector {
             display: flex;
             gap: 15px;
             margin-bottom: 15px;
             align-items: center;
             flex-wrap: wrap;
             flex-shrink: 0;
         }

        .model-selector select {
            padding: 10px 15px;
            border: 2px solid #e9ecef;
            border-radius: 8px;
            font-size: 14px;
            min-width: 200px;
        }

        .model-selector select:focus {
            outline: none;
            border-color: #667eea;
        }

                 .emotion-grid {
             display: grid;
             grid-template-columns: repeat(auto-fit, minmax(280px, 1fr));
             gap: 12px;
             flex: 1;
             margin-top: 10px;
         }

                 .emotion-card {
             background: #f8f9fa;
             border-radius: 12px;
             padding: 12px;
             border: 2px solid #e9ecef;
             transition: all 0.3s ease;
         }

        .emotion-card:hover {
            border-color: #667eea;
            box-shadow: 0 5px 15px rgba(102, 126, 234, 0.1);
        }

                 .emotion-card h3 {
             color: #495057;
             margin-bottom: 10px;
             font-size: 1em;
             display: flex;
             align-items: center;
             gap: 8px;
             padding: 6px 0;
             border-bottom: 1px solid #dee2e6;
         }

                 .emotion-icon {
             width: 20px;
             height: 20px;
             border-radius: 50%;
             display: flex;
             align-items: center;
             justify-content: center;
             font-size: 11px;
             font-weight: bold;
             color: white;
         }

        .emotion-icon.happy { background: #ffc107; }
        .emotion-icon.sad { background: #17a2b8; }
        .emotion-icon.angry { background: #dc3545; }
        .emotion-icon.neutral { background: #6c757d; }
        .emotion-icon.surprised { background: #fd7e14; }

                 .file-list {
             margin-top: 12px;
         }

                 .file-item {
             display: flex;
             align-items: center;
             justify-content: space-between;
             padding: 4px 8px;
             background: white;
             border-radius: 6px;
             margin-bottom: 4px;
             border: 1px solid #dee2e6;
         }

        .file-item:hover {
            background: #f8f9fa;
        }

                 .file-name {
             flex: 1;
             font-size: 12px;
             color: #495057;
         }

        .file-actions {
            display: flex;
            gap: 5px;
        }

                 .btn-small {
             padding: 6px 12px;
             font-size: 12px;
             border-radius: 4px;
             min-height: 28px;
             display: inline-flex;
             align-items: center;
             justify-content: center;
         }

                 .add-file-section {
             margin-top: 8px;
             padding-top: 8px;
             border-top: 1px solid #dee2e6;
         }

                 .file-input-group {
             display: flex;
             gap: 8px;
             margin-bottom: 4px;
             align-items: center;
             min-height: 36px;
         }

        .file-input-group input {
            flex: 1;
            padding: 8px 12px;
            border: 1px solid #ced4da;
            border-radius: 6px;
            font-size: 14px;
        }

        .file-input-group input:focus {
            outline: none;
            border-color: #667eea;
        }

                 .file-select {
             flex: 1;
             padding: 6px 10px;
             border: 1px solid #ced4da;
             border-radius: 6px;
             font-size: 13px;
             background: white;
             min-width: 0; /* 防止flex项目溢出 */
         }

        .file-select:focus {
            outline: none;
            border-color: #667eea;
        }

        /* 确保添加按钮不被挤压 */
        .file-input-group .btn-small {
            flex-shrink: 0;
            min-width: 50px;
            white-space: nowrap;
        }

                 .toast-container {
             position: fixed;
             top: 20px;
             right: 20px;
             z-index: 1000;
             max-width: 400px;
         }

         .toast {
             padding: 12px 16px;
             border-radius: 8px;
             margin-bottom: 10px;
             font-weight: 500;
             font-size: 14px;
             box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
             transform: translateX(100%);
             transition: transform 0.3s ease;
             opacity: 0;
         }

         .toast.show {
             transform: translateX(0);
             opacity: 1;
         }

         .toast-success {
             background: #d4edda;
             color: #155724;
             border: 1px solid #c3e6cb;
         }

         .toast-error {
             background: #f8d7da;
             color: #721c24;
             border: 1px solid #f5c6cb;
         }

         .toast-info {
             background: #d1ecf1;
             color: #0c5460;
             border: 1px solid #bee5eb;
         }

         .toast-warning {
             background: #fff3cd;
             color: #856404;
             border: 1px solid #ffeaa7;
         }

                            .status-indicator {
             position: absolute;
             top: 70px;
             left: 20px;
             display: flex;
             align-items: center;
             gap: 8px;
             font-size: 12px;
             color: #6c757d;
             padding: 6px 10px;
             background: #f8f9fa;
             border-radius: 6px;
             border: 1px solid #e9ecef;
             z-index: 10;
             max-width: 400px;
             box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
         }

         .status-dot {
             width: 8px;
             height: 8px;
             border-radius: 50%;
             animation: pulse 2s infinite;
         }

         .status-dot.success { background: #28a745; }
         .status-dot.error { background: #dc3545; }
         .status-dot.info { background: #17a2b8; }
         .status-dot.warning { background: #ffc107; }

         @keyframes pulse {
             0% { opacity: 1; }
             50% { opacity: 0.5; }
             100% { opacity: 1; }
         }

        .loading {
            display: inline-block;
            width: 20px;
            height: 20px;
            border: 3px solid #f3f3f3;
            border-top: 3px solid #667eea;
            border-radius: 50%;
            animation: spin 1s linear infinite;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

                 .hidden {
             display: none;
         }

         

                 .model-info {
             background: #e9ecef;
             padding: 12px;
             border-radius: 8px;
             margin-bottom: 15px;
             flex-shrink: 0;
         }

        .model-info h4 {
            margin-bottom: 10px;
            color: #495057;
        }

        .model-info p {
            margin-bottom: 5px;
            font-size: 14px;
            color: #6c757d;
        }


    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>🎭 Live2D 情感映射管理器</h1>
            <p>管理和配置Live2D角色的动作与表情映射</p>
        </div>

                 <div class="content">
                          <div class="model-selector">
                 <label for="model-select">选择Live2D模型：</label>
                 <select id="model-select" onchange="loadModelMapping()">
                     <option value="">请选择模型</option>
                 </select>
                 <button class="btn btn-success" onclick="saveMapping()">保存配置</button>
                 <button class="btn btn-secondary" onclick="resetMapping()">重置</button>
             </div>
             
             <div id="model-status-indicator" class="status-indicator hidden">
                 <span class="status-dot info"></span>
                 <span id="model-status-text">加载中...</span>
             </div>

            <div id="model-info" class="model-info hidden">
                <h4>模型信息</h4>
                <p id="model-path"></p>
                <p id="model-status"></p>
            </div>

            <div id="emotion-grid" class="emotion-grid">
                <!-- 情感卡片将通过JavaScript动态生成 -->
            </div>

            
        </div>
         </div>

     <div id="toast-container" class="toast-container"></div>

     <script>
        let currentModelConfig = {};
        let availableModels = [];
        let currentModel = '';
        let currentModelFiles = { motion_files: [], expression_files: [] };
        let emotionMappingConfig = {}; // 存储情绪映射配置

        // 页面加载时初始化
        document.addEventListener('DOMContentLoaded', function() {
            loadAvailableModels();
        });

        // 全局错误处理
        window.addEventListener('error', function(e) {
            console.error('JavaScript error:', e.error);
            showStatus('JavaScript错误: ' + e.error.message, 'error');
        });

        

        // 加载可用的模型列表
        async function loadAvailableModels() {
            try {
                const modelsResponse = await fetch('/api/live2d/models?simple=true');
                const modelsData = await modelsResponse.json();
                
                if (modelsData.success) {
                    availableModels = modelsData.models;
                    showStatus(`自动识别到 ${availableModels.length} 个Live2D模型`, 'success');
                } else {
                    showStatus('加载可用模型列表失败: ' + modelsData.error, 'error');
                    return;
                }
                
                updateModelSelector();
            } catch (error) {
                showStatus('加载模型列表时出错: ' + error.message, 'error');
            }
        }

        // 更新模型选择器
        function updateModelSelector() {
            const select = document.getElementById('model-select');
            select.innerHTML = '<option value="">请选择模型</option>';
            
            availableModels.forEach(model => {
                const option = document.createElement('option');
                option.value = model;
                option.textContent = model;
                select.appendChild(option);
            });
        }

        async function loadModelMapping() {
             const modelSelect = document.getElementById('model-select');
             const selectedModel = modelSelect.value;
             
             if (!selectedModel) {
                 showStatus('请先选择一个模型', 'error');
                 return;
             }

             try {
                 const statusIndicator = document.getElementById('model-status-indicator');
                 const statusText = document.getElementById('model-status-text');
                 const statusDot = statusIndicator.querySelector('.status-dot');
                 
                 statusIndicator.classList.remove('hidden');
                 statusText.textContent = '正在加载配置和模型文件...';
                 statusDot.className = 'status-dot info';
                 
                 const [configResponse, filesResponse, emotionMappingResponse] = await Promise.all([
                     fetch(`/api/live2d/model_config/${selectedModel}`),
                     fetch(`/api/live2d/model_files/${selectedModel}`),
                     fetch(`/api/live2d/emotion_mapping/${selectedModel}`)
                 ]);
                 
                 const configData = await configResponse.json();
                 const filesData = await filesResponse.json();
                 const emotionMappingData = await emotionMappingResponse.json();
                 
                 if (configData.success) {
                     currentModelConfig = configData.config;
                     currentModel = selectedModel;
                     
                     if (filesData.success) {
                         currentModelFiles = {
                             motion_files: filesData.motion_files,
                             expression_files: filesData.expression_files
                         };
                         
                         statusText.textContent = `已加载，发现 ${filesData.motion_files.length} 个动作文件和 ${filesData.expression_files.length} 个表情文件`;
                         statusDot.className = 'status-dot success';
                         
                         setTimeout(() => {
                             statusIndicator.classList.add('hidden');
                         }, 3000);
                         
                     } else {
                         currentModelFiles = { motion_files: [], expression_files: [] };
                         statusText.textContent = '配置加载成功，但无法获取模型文件';
                         statusDot.className = 'status-dot warning';
                         
                         setTimeout(() => {
                             statusIndicator.classList.add('hidden');
                         }, 3000);
                     }

                    if (emotionMappingData.success) {
                        emotionMappingConfig[currentModel] = emotionMappingData.config || { motions: {}, expressions: {} };
                    } else {
                        emotionMappingConfig[currentModel] = { motions: {}, expressions: {} };
                        showStatus('加载情绪映射配置失败: ' + emotionMappingData.error, 'error');
                    }
                     
                     // 自动为没有映射的模型添加映射
                     autoAddModelMapping(selectedModel);
                     
                     renderEmotionGrid();
                     showModelInfo();
                 } else {
                     statusText.textContent = '加载配置失败: ' + (configData.error || '未知错误');
                     statusDot.className = 'status-dot error';
                     
                     setTimeout(() => {
                         statusIndicator.classList.add('hidden');
                     }, 3000);
                 }
             } catch (error) {
                 const statusIndicator = document.getElementById('model-status-indicator');
                 const statusText = document.getElementById('model-status-text');
                 const statusDot = statusIndicator.querySelector('.status-dot');
                 
                 statusIndicator.classList.remove('hidden');
                 statusText.textContent = '加载配置时出错: ' + error.message;
                 statusDot.className = 'status-dot error';
                 
                 setTimeout(() => {
                     statusIndicator.classList.add('hidden');
                 }, 3000);
             }
         }

        // 渲染情感网格
        function renderEmotionGrid() {
            const grid = document.getElementById('emotion-grid');
            grid.innerHTML = '';

            const emotions = ['happy', 'sad', 'angry', 'neutral', 'surprised', 'Idle'];
            const emotionNames = {
                'happy': '开心',
                'sad': '悲伤', 
                'angry': '愤怒',
                'neutral': '中性',
                'surprised': '惊讶',
                'Idle': '待机'
            };

            emotions.forEach(emotion => {
                const card = createEmotionCard(emotion, emotionNames[emotion]);
                grid.appendChild(card);
            });
        }

        // 自动为没有映射的模型添加映射
        function autoAddModelMapping(modelName) {
            // 如果该模型在情绪映射配置中不存在，则自动添加
            if (!emotionMappingConfig[modelName]) {
                emotionMappingConfig[modelName] = {
                    motions: {},
                    expressions: {}
                };
                showStatus(`已为模型 ${modelName} 自动创建情绪映射配置`, 'success');
            }
        }

        // 创建情感卡片
        function createEmotionCard(emotion, emotionName) {
            const card = document.createElement('div');
            card.className = 'emotion-card';
            card.id = `emotion-${emotion}`;

            // 从情绪映射配置中获取文件列表
            const modelMapping = emotionMappingConfig[currentModel] || { motions: {}, expressions: {} };
            const motions = modelMapping.motions[emotion] || [];
            const expressions = modelMapping.expressions[emotion] || [];

            // 获取可用的文件列表
            const availableMotions = currentModelFiles.motion_files || [];
            const availableExpressions = currentModelFiles.expression_files || [];
            
            // 过滤掉已添加的文件
            const unusedMotions = availableMotions.filter(file => !motions.includes(file));
            const unusedExpressions = availableExpressions.filter(file => !expressions.includes(file));

            card.innerHTML = `
                <h3>
                    <span class="emotion-icon ${emotion}">${emotionName.charAt(0)}</span>
                    ${emotionName}
                </h3>
                
                <div class="file-list">
                    <h4>动作文件 (${motions.length})</h4>
                    <div id="motions-${emotion}">
                        ${motions.map(file => createFileItem(file, emotion, 'motions')).join('')}
                    </div>
                    <div class="add-file-section">
                        <div class="file-input-group">
                            <select id="motions-select-${emotion}" class="file-select">
                                <option value="">选择动作文件</option>
                                ${unusedMotions.map(file => `<option value="${file}">${file}</option>`).join('')}
                            </select>
                            <button class="btn btn-small btn-primary" onclick="addFileFromSelect('${emotion}', 'motions')" ${unusedMotions.length === 0 ? 'disabled' : ''} type="button">添加</button>
                        </div>
                    </div>
                </div>

                <div class="file-list">
                    <h4>表情文件 (${expressions.length})</h4>
                    <div id="expressions-${emotion}">
                        ${expressions.map(file => createFileItem(file, emotion, 'expressions')).join('')}
                    </div>
                    <div class="add-file-section">
                        <div class="file-input-group">
                            <select id="expressions-select-${emotion}" class="file-select">
                                <option value="">选择表情文件</option>
                                ${unusedExpressions.map(file => `<option value="${file}">${file}</option>`).join('')}
                            </select>
                            <button class="btn btn-small btn-primary" onclick="addFileFromSelect('${emotion}', 'expressions')" ${unusedExpressions.length === 0 ? 'disabled' : ''} type="button">添加</button>
                        </div>
                    </div>
                </div>
            `;

            return card;
        }

        // 创建文件项
        function createFileItem(fileName, emotion, type) {
            return `
                <div class="file-item">
                    <span class="file-name">${fileName}</span>
                    <div class="file-actions">
                        <button class="btn btn-small btn-danger" onclick="removeFile('${emotion}', '${type}', '${fileName}')">删除</button>
                    </div>
                </div>
            `;
        }

        // 从下拉框添加文件
        function addFileFromSelect(emotion, type) {
            const select = document.getElementById(`${type}-select-${emotion}`);
            const fileName = select.value;
            
            if (!fileName) {
                showStatus('请选择一个文件', 'error');
                return;
            }

            // 确保当前模型在情绪映射配置中存在
            if (!emotionMappingConfig[currentModel]) {
                emotionMappingConfig[currentModel] = { motions: {}, expressions: {} };
            }

            if (type === 'motions') {
                if (!emotionMappingConfig[currentModel].motions[emotion]) {
                    emotionMappingConfig[currentModel].motions[emotion] = [];
                }
                emotionMappingConfig[currentModel].motions[emotion].push(fileName);
            } else {
                if (!emotionMappingConfig[currentModel].expressions[emotion]) {
                    emotionMappingConfig[currentModel].expressions[emotion] = [];
                }
                emotionMappingConfig[currentModel].expressions[emotion].push(fileName);
            }

            select.value = '';
            renderEmotionGrid();
            showStatus(`已添加${type === 'motions' ? '动作' : '表情'}文件: ${fileName}`, 'success');
        }

        // 删除文件
        function removeFile(emotion, type, fileName) {
            const modelMapping = emotionMappingConfig[currentModel];
            if (!modelMapping) return;

            if (type === 'motions') {
                const motions = modelMapping.motions[emotion];
                if (motions) {
                    const index = motions.indexOf(fileName);
                    if (index > -1) {
                        motions.splice(index, 1);
                    }
                }
            } else {
                const expressions = modelMapping.expressions[emotion];
                if (expressions) {
                    const index = expressions.indexOf(fileName);
                    if (index > -1) {
                        expressions.splice(index, 1);
                    }
                }
            }
            renderEmotionGrid();
            showStatus(`已删除${type === 'motions' ? '动作' : '表情'}文件: ${fileName}`, 'success');
        }

        // 保存映射配置
        async function saveMapping() {
            if (!currentModel) {
                showStatus('请先选择一个模型', 'error');
                return;
            }

            try {
                showStatus('正在保存配置...', 'info');
                
                // 保存情绪映射配置
                const emotionResponse = await fetch(`/api/live2d/emotion_mapping/${currentModel}`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify(emotionMappingConfig[currentModel])
                });

                const emotionData = await emotionResponse.json();
                
                if (emotionData.success) {
                    showStatus('配置保存成功', 'success');
                } else {
                    showStatus('保存配置失败: ' + emotionData.error, 'error');
                }
            } catch (error) {
                showStatus('保存配置时出错: ' + error.message, 'error');
            }
        }

        // 重置映射
        function resetMapping() {
            if (confirm('确定要重置当前配置吗？这将清空所有动作和表情文件。')) {
                if (!emotionMappingConfig[currentModel]) {
                    emotionMappingConfig[currentModel] = { motions: {}, expressions: {} };
                }
                emotionMappingConfig[currentModel].motions = { "Idle": [] };
                emotionMappingConfig[currentModel].expressions = {};
                renderEmotionGrid();
                showStatus('配置已重置', 'success');
            }
        }

                 // 显示模型信息
         function showModelInfo() {
             const info = document.getElementById('model-info');
             const path = document.getElementById('model-path');
             const status = document.getElementById('model-status');
             
             info.classList.remove('hidden');
             path.textContent = `模型: ${currentModel}`;
             
             // 显示模型文件的总数量，而不是已配置的数量
             const totalMotionFiles = currentModelFiles.motion_files.length;
             const totalExpressionFiles = currentModelFiles.expression_files.length;
             status.textContent = `动作文件: ${totalMotionFiles} | 表情文件: ${totalExpressionFiles}`;
         }
         
                 // 显示toast通知
         function showStatus(message, type) {
             const toastContainer = document.getElementById('toast-container');
             const toast = document.createElement('div');
             toast.className = `toast toast-${type}`;
             toast.textContent = message;
             
             toastContainer.appendChild(toast);
             
             // 触发动画
             setTimeout(() => {
                 toast.classList.add('show');
             }, 10);
             
             // 自动移除
             setTimeout(() => {
                 toast.classList.remove('show');
                 setTimeout(() => {
                     if (toast.parentNode) {
                         toast.parentNode.removeChild(toast);
                     }
                 }, 300);
             }, 3000);
         }

                   // 打开Live2D动作预览器
          function openPreview() {
              // 创建模态框
              const modal = document.createElement('div');
              modal.id = 'preview-modal';
              modal.style.cssText = `
                  position: fixed;
                  top: 0;
                  left: 0;
                  width: 100%;
                  height: 100%;
                  background: rgba(0, 0, 0, 0.8);
                  z-index: 9999;
                  display: flex;
                  justify-content: center;
                  align-items: center;
                  opacity: 0;
                  transition: opacity 0.3s ease;
              `;
              
              // 创建预览容器
              const previewContainer = document.createElement('div');
              previewContainer.style.cssText = `
                  background: white;
                  border-radius: 15px;
                  box-shadow: 0 20px 60px rgba(0, 0, 0, 0.3);
                  width: 95%;
                  height: 95%;
                  max-width: 1400px;
                  max-height: 900px;
                  position: relative;
                  overflow: hidden;
                  transform: scale(0.9);
                  transition: transform 0.3s ease;
              `;
              
              // 创建提示信息
              const tipElement = document.createElement('div');
              tipElement.innerHTML = '💡 点击空白处关闭预览';
              tipElement.style.cssText = `
                  position: absolute;
                  top: 15px;
                  left: 50%;
                  transform: translateX(-50%);
                  background: rgba(0, 0, 0, 0.7);
                  color: white;
                  padding: 8px 16px;
                  border-radius: 20px;
                  font-size: 14px;
                  font-weight: 500;
                  z-index: 10000;
                  opacity: 0.9;
                  transition: opacity 0.3s ease;
              `;
              
              // 创建iframe
              const iframe = document.createElement('iframe');
              iframe.src = '/live2d_preview';
              iframe.style.cssText = `
                  width: 100%;
                  height: 100%;
                  border: none;
                  border-radius: 15px;
              `;
              
              // 组装模态框
              previewContainer.appendChild(tipElement);
              previewContainer.appendChild(iframe);
              modal.appendChild(previewContainer);
              document.body.appendChild(modal);
              
              // 显示动画
              setTimeout(() => {
                  modal.style.opacity = '1';
                  previewContainer.style.transform = 'scale(1)';
              }, 10);
              
              // 3秒后隐藏提示
              setTimeout(() => {
                  tipElement.style.opacity = '0';
                  setTimeout(() => {
                      if (tipElement.parentNode) {
                          tipElement.parentNode.removeChild(tipElement);
                      }
                  }, 300);
              }, 3000);
              
              // 关闭功能
              function closeModal() {
                  modal.style.opacity = '0';
                  previewContainer.style.transform = 'scale(0.9)';
                  setTimeout(() => {
                      if (modal.parentNode) {
                          modal.parentNode.removeChild(modal);
                      }
                  }, 300);
              }
              
              modal.onclick = (e) => {
                  if (e.target === modal) {
                      closeModal();
                  }
              };
              
              // ESC键关闭
              const escHandler = (e) => {
                  if (e.key === 'Escape') {
                      closeModal();
                      document.removeEventListener('keydown', escHandler);
                  }
              };
              document.addEventListener('keydown', escHandler);
          }
    </script>
</body>
</html> 